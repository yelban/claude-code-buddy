// src/ui/AttributionManager.ts
import { randomBytes } from 'crypto';
import type { UIEventBus } from './UIEventBus.js';
import type { AttributionMessage, GitHubIssueSuggestion, ErrorDetails } from './types.js';

/**
 * Manages attribution tracking for success/error events
 */
export class AttributionManager {
  private eventBus: UIEventBus;
  private attributions: AttributionMessage[] = [];
  private readonly maxStoredAttributions: number = 100;

  constructor(eventBus: UIEventBus) {
    this.eventBus = eventBus;
  }

  /**
   * Record successful task completion
   */
  public recordSuccess(
    agentIds: string[],
    taskDescription: string,
    metadata?: { timeSaved?: number; tokensUsed?: number }
  ): void {
    const attribution: AttributionMessage = {
      id: this.generateId(),
      type: 'success',
      timestamp: new Date(),
      agentIds,
      taskDescription,
      metadata,
    };

    this.storeAttribution(attribution);
    this.eventBus.emitAttribution(attribution);
  }

  /**
   * Record task error/failure
   */
  public recordError(
    agentIds: string[],
    taskDescription: string,
    error: Error,
    suggestGitHubIssue: boolean = true
  ): void {
    const attribution: AttributionMessage = {
      id: this.generateId(),
      type: 'error',
      timestamp: new Date(),
      agentIds,
      taskDescription,
      metadata: {
        error: {
          name: error.name,
          message: error.message,
          stack: error.stack,
        },
        suggestGitHubIssue,
      },
    };

    this.storeAttribution(attribution);
    this.eventBus.emitAttribution(attribution);
  }

  /**
   * Generate GitHub issue suggestion from error attribution
   */
  public generateIssueSuggestion(
    attribution: AttributionMessage,
    error: Error
  ): GitHubIssueSuggestion {
    const title = `[smart-agents] Error: ${error.message.substring(0, 80)}`;

    const sanitizedStack = this.sanitizeSensitiveData(error.stack || '');
    const sanitizedMessage = this.sanitizeSensitiveData(error.message);

    const body = `## Error Report

**Description:** ${attribution.taskDescription}

**Error Type:** ${error.name}

**Error Message:** ${sanitizedMessage}

**Agent(s) Involved:** ${attribution.agentIds.join(', ')}

**Timestamp:** ${attribution.timestamp.toISOString()}

### Stack Trace

\`\`\`
${sanitizedStack}
\`\`\`

### Environment

- **smart-agents Version:** [Auto-detected]
- **Node.js Version:** ${process.version}
- **Platform:** ${process.platform}

### Additional Context

[Add any relevant context about what you were trying to do]

---

*This issue was auto-generated by smart-agents error reporting. Sensitive data has been sanitized.*`;

    return {
      title,
      body,
      labels: ['bug', 'smart-agents', 'auto-reported'],
    };
  }

  /**
   * Get recent attributions (most recent first)
   */
  public getRecentAttributions(limit: number = 10): AttributionMessage[] {
    return this.attributions.slice(0, limit);
  }

  /**
   * Store attribution in memory
   */
  private storeAttribution(attribution: AttributionMessage): void {
    this.attributions.unshift(attribution); // Add to beginning

    // Limit stored attributions
    if (this.attributions.length > this.maxStoredAttributions) {
      this.attributions = this.attributions.slice(0, this.maxStoredAttributions);
    }
  }

  /**
   * Sanitize sensitive data from strings
   */
  private sanitizeSensitiveData(text: string): string {
    let sanitized = text;

    // Remove user home directories
    sanitized = sanitized.replace(/\/Users\/[^\/]+/g, '/Users/[USER]');
    sanitized = sanitized.replace(/\/home\/[^\/]+/g, '/home/[USER]');
    sanitized = sanitized.replace(/C:\\Users\\[^\\]+/g, 'C:\\Users\\[USER]');

    // Remove API keys/tokens (common patterns)
    sanitized = sanitized.replace(/sk-[a-zA-Z0-9]{20,}/g, 'sk-[REDACTED]');
    sanitized = sanitized.replace(/ghp_[a-zA-Z0-9]{20,}/g, 'ghp_[REDACTED]');
    sanitized = sanitized.replace(/API_KEY=\S+/g, 'API_KEY=[REDACTED]');
    sanitized = sanitized.replace(/token:\s*\S+/gi, 'token: [REDACTED]');

    // Remove potential passwords
    sanitized = sanitized.replace(/password:\s*\S+/gi, 'password: [REDACTED]');
    sanitized = sanitized.replace(/passwd=\S+/gi, 'passwd=[REDACTED]');

    return sanitized;
  }

  /**
   * Generate unique attribution ID
   */
  private generateId(): string {
    return `attr-${randomBytes(8).toString('hex')}`;
  }
}
