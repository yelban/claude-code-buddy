name: Publish to npm

# This workflow automatically publishes the package to npm when a GitHub Release is published.
#
# Workflow: Create GitHub Release â†’ Trigger this workflow â†’ Build â†’ Test â†’ Publish to npm
# Duration: ~2-3 minutes
#
# Requirements:
#   - NPM_TOKEN secret must be configured in repository settings
#   - Token must have publish permissions for @pcircle scope
#
# For detailed release instructions, see docs/RELEASE_PROCESS.md

on:
  release:
    types: [published]

jobs:
  publish:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write # For npm provenance

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Run tests
        run: npm test -- --run

      - name: Run installation tests
        run: npm run test:install

      - name: Verify package contents
        run: |
          echo "ðŸ“¦ Verifying package contents..."
          npm pack --dry-run
          echo ""
          echo "ðŸ“Š Package size:"
          TARBALL=$(npm pack --silent)
          du -sh "$TARBALL"
          rm "$TARBALL"
          echo ""
          echo "âœ… Package verification complete"

      - name: Publish to npm
        run: npm publish --access public --provenance
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      # Log publication success (replaced invalid GitHub API call with simple logging)
      - name: Log success
        run: |
          echo "âœ… Successfully published @pcircle/memesh@${{ github.event.release.tag_name }} to npm"
          echo "ðŸ“¦ Package URL: https://www.npmjs.com/package/@pcircle/memesh"
