name: Documentation Check

# Validates documentation links and formatting
# Runs on pull requests and pushes to main to catch broken links early
# Security: Uses only repository files, no external user input

on:
  push:
    branches:
      - main
    paths:
      - '**.md'
      - 'docs/**'
      - '.github/workflows/docs-check.yml'
  pull_request:
    paths:
      - '**.md'
      - 'docs/**'
      - '.github/workflows/docs-check.yml'

jobs:
  link-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Check markdown links in source files
        run: |
          # Install markdown-link-check
          npm install -g markdown-link-check

          # Find and check markdown files, excluding build artifacts
          find . -name "*.md" \
            -not -path "./node_modules/*" \
            -not -path "./.git/*" \
            -not -path "./dist/*" \
            -not -path "./.claude-plugin/*" \
            -exec markdown-link-check '{}' --config .github/markdown-link-check-config.json -q \;

      - name: Check for broken internal links
        run: |
          echo "üîç Checking internal file references..."

          # Find all markdown files (no user input, only repo files)
          # Exclude build artifacts: dist/, .claude-plugin/, node_modules/, .git/
          MD_FILES=$(find . -name "*.md" -not -path "./node_modules/*" -not -path "./.git/*" -not -path "./dist/*" -not -path "./.claude-plugin/*")

          BROKEN_LINKS=0

          # Check each markdown file for internal links
          for file in $MD_FILES; do
            # Extract internal links (not starting with http)
            LINKS=$(grep -oP '\[.*?\]\(\K[^http][^\)]+(?=\))' "$file" 2>/dev/null || true)

            for link in $LINKS; do
              # Remove anchor from link
              FILE_PATH=$(echo "$link" | cut -d'#' -f1)

              # Skip empty paths (anchors only)
              if [ -z "$FILE_PATH" ]; then
                continue
              fi

              # Skip directory links (ending with /)
              if [[ "$FILE_PATH" == */ ]]; then
                continue
              fi

              # Resolve relative path
              DIR=$(dirname "$file")
              FULL_PATH="$DIR/$FILE_PATH"

              # Check if file or directory exists
              if [ ! -e "$FULL_PATH" ]; then
                echo "‚ùå Broken link in $file: $link"
                BROKEN_LINKS=$((BROKEN_LINKS + 1))
              fi
            done
          done

          if [ $BROKEN_LINKS -gt 0 ]; then
            echo ""
            echo "‚ùå Found $BROKEN_LINKS broken internal link(s)"
            exit 1
          else
            echo "‚úÖ All internal links are valid"
          fi

      - name: Lint markdown files
        run: |
          echo "üìù Linting markdown files..."
          npx markdownlint-cli '**/*.md' \
            --ignore node_modules \
            --ignore .git \
            --config .github/markdownlint-config.json || true
          echo "‚úÖ Markdown linting complete"
