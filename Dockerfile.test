# Docker æ¸¬è©¦ç’°å¢ƒ - æ¨¡æ“¬å…¨æ–°ç”¨æˆ¶å®‰è£
FROM node:20-slim

# å®‰è£å¿…è¦å·¥å…·
RUN apt-get update && apt-get install -y \
    git \
    curl \
    && rm -rf /var/lib/apt/lists/*

# è¨­ç½®å·¥ä½œç›®éŒ„
WORKDIR /test

# è¤‡è£½å°ˆæ¡ˆæª”æ¡ˆ
COPY package*.json ./
COPY tsconfig.json ./
COPY vitest.config.ts ./
COPY vitest.global-setup.ts ./
COPY eslint.config.js ./
COPY src/ ./src/
COPY tests/ ./tests/
COPY scripts/ ./scripts/
COPY plugin.json ./
COPY mcp.json ./
COPY README.md ./
COPY LICENSE ./
COPY .env.example ./

# æ¸¬è©¦è…³æœ¬
RUN echo '#!/bin/bash\n\
set -e\n\
echo "ğŸ§ª æ¸¬è©¦ç’°å¢ƒï¼šDocker å®¹å™¨ï¼ˆæ¨¡æ“¬å…¨æ–°ç”¨æˆ¶ï¼‰"\n\
echo "Node version: $(node -v)"\n\
echo "npm version: $(npm -v)"\n\
echo ""\n\
\n\
echo "=== æ¸¬è©¦ 1: npm install (å¾ package.json) ==="\n\
npm install\n\
echo "âœ… npm install æˆåŠŸ"\n\
echo ""\n\
\n\
echo "=== æ¸¬è©¦ 2: Build ==="\n\
npm run build\n\
echo "âœ… Build æˆåŠŸ"\n\
echo ""\n\
\n\
echo "=== æ¸¬è©¦ 3: Plugin Build ==="\n\
npm run build:plugin\n\
echo "âœ… Plugin build æˆåŠŸ"\n\
echo ""\n\
\n\
echo "=== æ¸¬è©¦ 4: é©—è­‰æª”æ¡ˆçµæ§‹ ==="\n\
test -f .claude-plugin/memesh/.claude-plugin/plugin.json && echo "âœ… plugin.json" || exit 1\n\
test -f .claude-plugin/memesh/.mcp.json && echo "âœ… .mcp.json" || exit 1\n\
test -f .claude-plugin/memesh/dist/mcp/server-bootstrap.js && echo "âœ… server-bootstrap.js" || exit 1\n\
echo "âœ… æª”æ¡ˆçµæ§‹æ­£ç¢º"\n\
echo ""\n\
\n\
echo "=== æ¸¬è©¦ 5: é©—è­‰ JSON æ ¼å¼ ==="\n\
node -e "const p = require(\"./.claude-plugin/memesh/.claude-plugin/plugin.json\"); if (p.mcpServers) throw new Error(\"plugin.json should not have mcpServers\");" && echo "âœ… plugin.json æ ¼å¼æ­£ç¢º" || exit 1\n\
node -e "const m = require(\"./.claude-plugin/memesh/.mcp.json\"); if (!m.memesh) throw new Error(\"Invalid mcp.json\");" && echo "âœ… mcp.json æ ¼å¼æ­£ç¢º" || exit 1\n\
echo ""\n\
\n\
echo "=== æ¸¬è©¦ 6: æ¸¬è©¦åŸ·è¡Œ ==="\n\
npm test\n\
echo "âœ… æ¸¬è©¦é€šé"\n\
echo ""\n\
\n\
echo "=== æ¸¬è©¦ 7: npm pack æ¸¬è©¦ ==="\n\
npm pack\n\
TARBALL=$(ls -t pcircle-memesh-*.tgz | head -1)\n\
tar -tzf "$TARBALL" | grep -q "package/mcp.json" && echo "âœ… tarball åŒ…å« mcp.json" || exit 1\n\
tar -tzf "$TARBALL" | grep -q "package/plugin.json" && echo "âœ… tarball åŒ…å« plugin.json" || exit 1\n\
echo "âœ… npm pack æ­£ç¢º"\n\
echo ""\n\
\n\
echo "=== æ¸¬è©¦ 8: MCP Server å¯åŸ·è¡Œæ€§ ==="\n\
node ./.claude-plugin/memesh/dist/mcp/server-bootstrap.js --version && echo "âœ… MCP server å¯åŸ·è¡Œ" || echo "âš ï¸  éœ€è¦ stdinï¼ˆæ­£å¸¸ï¼‰"\n\
echo ""\n\
\n\
echo "âœ…âœ…âœ… æ‰€æœ‰æ¸¬è©¦é€šéï¼å®‰è£æµç¨‹åœ¨ä¹¾æ·¨ç’°å¢ƒä¸­é©—è­‰æˆåŠŸï¼ âœ…âœ…âœ…"\n\
' > /test/run-tests.sh && chmod +x /test/run-tests.sh

CMD ["/test/run-tests.sh"]
