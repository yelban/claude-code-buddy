#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "ğŸ” Pre-commit: Validating installation files..."

# Check if installation-critical files are being modified
CRITICAL_FILES="package.json plugin.json mcp.json scripts/prepare-plugin.js scripts/quick-install.sh"
MODIFIED_CRITICAL=false

for file in $CRITICAL_FILES; do
  if git diff --cached --name-only | grep -q "^$file$"; then
    MODIFIED_CRITICAL=true
    echo "âš ï¸  Critical file modified: $file"
  fi
done

if [ "$MODIFIED_CRITICAL" = true ]; then
  echo ""
  echo "ğŸš¨ å®‰è£é—œéµæª”æ¡ˆè¢«ä¿®æ”¹ï¼åŸ·è¡Œé©—è­‰..."
  echo ""

  # Validate JSON files
  echo "1. é©—è­‰ JSON æª”æ¡ˆæ ¼å¼..."

  if [ -f package.json ]; then
    node -e "require('./package.json')" || {
      echo "âŒ package.json æ ¼å¼éŒ¯èª¤"
      exit 1
    }
  fi

  if [ -f plugin.json ]; then
    node -e "
    const plugin = require('./plugin.json');
    if (plugin.mcpServers) {
      console.error('âŒ plugin.json ä¸æ‡‰åŒ…å« mcpServers æ¬„ä½');
      process.exit(1);
    }
    " || exit 1
  fi

  if [ -f mcp.json ]; then
    node -e "
    const mcp = require('./mcp.json');
    if (!mcp.memesh || !mcp.memesh.command || !mcp.memesh.args) {
      console.error('âŒ mcp.json æ ¼å¼ä¸æ­£ç¢º');
      process.exit(1);
    }
    if (!mcp.memesh.args[0].includes('CLAUDE_PLUGIN_ROOT')) {
      console.error('âŒ mcp.json å¿…é ˆä½¿ç”¨ \${CLAUDE_PLUGIN_ROOT} è®Šæ•¸');
      process.exit(1);
    }
    " || exit 1
  fi

  echo "âœ… JSON æª”æ¡ˆæ ¼å¼æ­£ç¢º"
  echo ""

  # Check if tests pass
  echo "2. åŸ·è¡Œæ¸¬è©¦..."
  npm test --silent || {
    echo "âŒ æ¸¬è©¦å¤±æ•—"
    exit 1
  }
  echo "âœ… æ¸¬è©¦é€šé"
  echo ""

  echo "âœ… æ‰€æœ‰é©—è­‰é€šé"
  echo ""
  echo "âš ï¸  æé†’ï¼š"
  echo "   - ç¢ºä¿å·²æ›´æ–° INSTALLATION_STANDARD.mdï¼ˆå¦‚æœå®‰è£æµç¨‹æœ‰è®Šï¼‰"
  echo "   - ç¢ºä¿å·²æ›´æ–° PLUGIN_DEPLOYMENT_CHECKLIST.md"
  echo "   - åœ¨ push å‰åŸ·è¡Œå®Œæ•´çš„ pre-deployment-check.sh"
  echo ""
fi

exit 0
